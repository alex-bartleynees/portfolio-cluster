---
- name: OVHcloud VPS Security Hardening
  hosts: all
  become: true
  vars:
    # Security settings
    disable_standard_ssh: true
    enable_fail2ban: false  # Not needed with Tailscale SSH
    ssh_hardening: true
    
    # Allowed SSH users (if keeping standard SSH)
    ssh_allowed_users: []
    
    # Network security
    enable_syn_cookies: true
    disable_ipv6: false

  tasks:
    - name: Update system packages
      dnf:
        name: '*'
        state: latest

    - name: Check if reboot is required after kernel update
      shell: |
        RUNNING_KERNEL=$(uname -r)
        LATEST_KERNEL=$(rpm -q kernel --last | head -1 | awk '{print $1}' | sed 's/kernel-//')
        if [ "$RUNNING_KERNEL" != "$LATEST_KERNEL" ]; then
          echo "reboot_required"
        else
          echo "no_reboot"
        fi
      register: reboot_check
      changed_when: false

    - name: Notify if reboot is required
      debug:
        msg: |
          WARNING: Kernel update detected. A reboot is required.
          Running kernel: {{ ansible_kernel }}
          Please reboot and re-run this playbook.
      when: reboot_check.stdout == "reboot_required"

    - name: Fail if kernel update requires reboot
      fail:
        msg: "Kernel was updated. Please reboot the system and re-run this playbook."
      when: reboot_check.stdout == "reboot_required"

    - name: Install EPEL repository
      dnf:
        name: epel-release
        state: present

    - name: Install kernel modules and headers
      dnf:
        name:
          - kernel-modules
          - kernel-modules-extra
          - kernel-devel
        state: present

    - name: Load br_netfilter kernel module
      modprobe:
        name: br_netfilter
        state: present

    - name: Ensure br_netfilter module loads on boot
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: br_netfilter
        create: yes

    - name: Install security packages
      dnf:
        name:
          - fail2ban
          - dnf-automatic
          - aide  # Advanced Intrusion Detection Environment (rkhunter alternative)
        state: present

    - name: Configure SSH hardening
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
        - { regexp: '^#?Protocol', line: 'Protocol 2' }
      when: ssh_hardening and not disable_standard_ssh
      notify: restart sshd

    - name: Restrict SSH to specific users
      lineinfile:
        path: /etc/ssh/sshd_config
        line: "AllowUsers {{ ssh_allowed_users | join(' ') }}"
        backup: yes
      when: ssh_allowed_users | length > 0 and not disable_standard_ssh
      notify: restart sshd

    - name: Disable SSH daemon (using Tailscale SSH only)
      systemd:
        name: sshd
        state: stopped
        enabled: false
      when: disable_standard_ssh

    - name: Configure fail2ban for SSH (if keeping standard SSH)
      copy:
        content: |
          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/secure
          maxretry = 3
          bantime = 3600
          findtime = 600
          
          [sshd-ddos]
          enabled = true
          port = ssh
          filter = sshd-ddos
          logpath = /var/log/secure
          maxretry = 2
          bantime = 7200
          findtime = 120
        dest: /etc/fail2ban/jail.local
        backup: yes
      when: enable_fail2ban and not disable_standard_ssh
      notify: restart fail2ban

    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        state: started
        enabled: true
      when: enable_fail2ban and not disable_standard_ssh

    - name: Configure kernel parameters for security and Kubernetes
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-k8s-cri.conf
        sysctl_set: yes
        state: present
      loop:
        # Bridge netfilter (required for Kubernetes)
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        # IP forwarding (required for Kubernetes)
        - { name: 'net.ipv4.ip_forward', value: '1' }
        # Network security
        - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
        - { name: 'net.ipv4.conf.default.send_redirects', value: '0' }
        - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
        - { name: 'net.ipv4.conf.default.accept_redirects', value: '0' }
        - { name: 'net.ipv4.conf.all.secure_redirects', value: '0' }
        - { name: 'net.ipv4.conf.default.secure_redirects', value: '0' }
        - { name: 'net.ipv4.conf.all.log_martians', value: '1' }
        - { name: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
        - { name: 'net.ipv4.icmp_ignore_bogus_error_responses', value: '1' }
        - { name: 'net.ipv4.tcp_syncookies', value: '1' }
        # Memory protection
        - { name: 'kernel.dmesg_restrict', value: '1' }
        - { name: 'kernel.kptr_restrict', value: '2' }
        - { name: 'kernel.yama.ptrace_scope', value: '1' }

    - name: Configure dnf-automatic
      lineinfile:
        path: /etc/dnf/automatic.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^upgrade_type =', line: 'upgrade_type = security' }
        - { regexp: '^apply_updates =', line: 'apply_updates = yes' }
        - { regexp: '^emit_via =', line: 'emit_via = email' }

    - name: Enable dnf-automatic timer
      systemd:
        name: dnf-automatic.timer
        state: started
        enabled: true

    - name: Set secure file permissions
      file:
        path: "{{ item }}"
        mode: '0600'
      loop:
        - /etc/ssh/sshd_config
        - /etc/shadow
        - /etc/gshadow
      ignore_errors: true

    - name: Remove unnecessary packages
      package:
        name:
          - telnet
          - rsh-server
          - rsh
          - ypbind
          - ypserv
          - tftp
          - tftp-server
          - talk
          - talk-server
        state: absent
      ignore_errors: true

    - name: Initialize AIDE database
      command: aide --init
      args:
        creates: /var/lib/aide/aide.db.new.gz
      ignore_errors: true

    - name: Copy AIDE database
      command: cp /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
      args:
        creates: /var/lib/aide/aide.db.gz
      ignore_errors: true

    - name: Configure log rotation
      copy:
        content: |
          /var/log/messages {
              weekly
              rotate 4
              compress
              delaycompress
              missingok
              notifempty
              create 644 root root
          }
        dest: /etc/logrotate.d/syslog
        backup: yes

    - name: Display security status
      debug:
        msg: |
          OVHcloud VPS Security Hardening Complete:
          - SSH hardening: {{ ssh_hardening }}
          - Standard SSH disabled: {{ disable_standard_ssh }}
          - Fail2ban enabled: {{ enable_fail2ban }}
          - Kernel security parameters applied
          - Automatic updates configured
          - Unnecessary services removed
          
          Next steps:
          1. Verify Tailscale SSH access works
          2. Test UFW firewall rules
          3. Monitor logs for any issues

  handlers:
    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted
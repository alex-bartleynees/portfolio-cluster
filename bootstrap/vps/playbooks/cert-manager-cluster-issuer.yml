---
- name: Install cert-manager ClusterIssuer
  hosts: k8s_master
  become: false
  vars:
    kube_config_dir: "/home/{{ ansible_user }}/.kube"

  tasks:
    - name: Wait for cert-manager CRDs to be available
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: clusterissuers.cert-manager.io
      register: crd_check
      until: crd_check.resources | length > 0
      retries: 30
      delay: 10
      environment:
        KUBECONFIG: "{{ kube_config_dir }}/config"

    - name: Create letsencrypt-prod ClusterIssuer
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: alex@alexbartleynees.com
              privateKeySecretRef:
                name: letsencrypt-prod
              solvers:
              - http01:
                  ingress:
                    class: nginx
      environment:
        KUBECONFIG: "{{ kube_config_dir }}/config"

    - name: Verify ClusterIssuer is ready
      kubernetes.core.k8s_info:
        api_version: cert-manager.io/v1
        kind: ClusterIssuer
        name: letsencrypt-prod
      register: cluster_issuer
      until: cluster_issuer.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
      retries: 10
      delay: 30
      environment:
        KUBECONFIG: "{{ kube_config_dir }}/config"

    - name: Display ClusterIssuer status
      debug:
        msg: "ClusterIssuer letsencrypt-prod is ready"
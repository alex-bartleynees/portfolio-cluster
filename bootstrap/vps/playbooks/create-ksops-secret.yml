---
- name: Create KSOPS Secret in ArgoCD
  hosts: k8s_master
  become: false
  vars:
    kube_config_dir: "{{ ansible_env.HOME }}/.kube"
    gpg_email: "argocd@alexbartleynees.com"
    temp_dir: "/tmp/ksops-setup"

  tasks:
    - name: Create temporary directory
      file:
        path: "{{ temp_dir }}"
        state: directory
        mode: "0700"

    - name: Export GPG private key
      shell: |
        gpg --export-secret-key {{ gpg_email }} | base64 > {{ temp_dir }}/private.key
      args:
        creates: "{{ temp_dir }}/private.key"

    - name: Create namespace if it doesn't exist
      shell: |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ kube_config_dir }}/config"
      register: namespace_result
      changed_when: namespace_result.rc == 0

    - name: Create temporary secret manifest
      copy:
        dest: "{{ temp_dir }}/ksops-secret.yaml"
        content: |
          apiVersion: v1
          kind: Secret
          metadata:
            name: ksops-secret
            namespace: argocd
          type: Opaque
          data:
            private.key: "{{ lookup('file', temp_dir + '/private.key') }}"

    - name: Apply KSOPS secret
      command: kubectl apply -f {{ temp_dir }}/ksops-secret.yaml
      environment:
        KUBECONFIG: "{{ kube_config_dir }}/config"
      register: secret_result
      changed_when: secret_result.rc == 0

    - name: Verify secret creation
      command: kubectl get secret ksops-secret -n argocd
      environment:
        KUBECONFIG: "{{ kube_config_dir }}/config"
      register: verify_result
      changed_when: false

    - name: Clean up temporary files
      file:
        path: "{{ temp_dir }}"
        state: absent

    - name: Display results
      debug:
        msg:
          - "KSOPS secret creation status: {{ 'Success' if secret_result.rc == 0 else 'Failed' }}"
          - "Secret verification: {{ verify_result.stdout }}"
